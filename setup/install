#!/usr/bin/env bash

# TODO: cargo install lolcat
# TODO: sudo pacman -S figlet xclip
# TODO: Put https://www.figlet.org/fonts/rectangles.flf in `$(figlet -I 2)`.

# Stops further execution after any error.
set -e

SETUP_DIR=$(dirname "$(realpath "$0")")
ROOT_DIR="$(dirname "$SETUP_DIR")"
XDG_BIN_HOME="${XDG_BIN_HOME:-$HOME/.local/bin}"

source "$SETUP_DIR"/helpers.sh

# Check if ~/.local/bin is in $PATH so we can install getnf if necessary.
function prep_local_bin {
  [ ! -d "$XDG_BIN_HOME" ] && mkdir -p "$XDG_BIN_HOME"

  if ! echo "$PATH" | tr ':' '\n' | grep -qx "$XDG_BIN_HOME"; then
    echo "$(cross) ERROR: $XDG_BIN_HOME needs to be in your \$PATH."
    exit 1
  fi

  echo "$(check) ~/.local/bin is in \$PATH"
}

function prep_fonts_dir {
  if [ "$(uname -s)" == 'darwin' ]; then
    readonly FONTS_DIR="$HOME"/Library/Fonts
  else
    readonly FONTS_DIR="$XDG_DATA_HOME"/fonts
  fi
}

function is_font_installed {
  local font_name="$1"

  if [ "$(uname -s)" == 'darwin' ]; then
    # On macOS, check if any font files with the name exist
    # Search recursively and check for both .ttf and .otf extensions
    if find "$FONTS_DIR" -type f \( -name "*${font_name}*.ttf" -o -name "*${font_name}*.otf" \) 2>/dev/null | grep -q .; then
      return 0
    fi
    # Also check system fonts directory as fallback
    if find /Library/Fonts -type f \( -name "*${font_name}*.ttf" -o -name "*${font_name}*.otf" \) 2>/dev/null | grep -q .; then
      return 0
    fi
    return 1
  else
    # On Linux, use fc-list with specific format to ensure consistent matching
    # Check for the font family name in the output
    fc-list : family | grep -qi "^${font_name}" || fc-list : family | grep -qi "${font_name}"
  fi
}

function install_fonts {
  local fonts_to_install=()

  # Check each font and add to install list if not present
  if ! is_font_installed "DroidSansMono"; then
    fonts_to_install+=("DroidSansMono")
  else
    echo "$(check) DroidSansMono Nerd Font already installed"
  fi

  if ! is_font_installed "Hack"; then
    fonts_to_install+=("Hack")
  else
    echo "$(check) Hack Nerd Font already installed"
  fi

  if ! is_font_installed "Noto"; then
    fonts_to_install+=("Noto")
  else
    echo "$(check) Noto Nerd Font already installed"
  fi

  # Only install getnf and fonts if there are fonts to install
  if [ ${#fonts_to_install[@]} -eq 0 ]; then
    echo "$(check) All Nerd fonts already installed"
    return
  fi

  # Install getnf if not already installed
  if [ ! -f "$HOME"/.local/bin/getnf ]; then
    curl -fsSL https://raw.githubusercontent.com/getnf/getnf/main/install.sh | bash
  fi

  echo "$(check) getnf is installed"

  # Install missing fonts
  for font in "${fonts_to_install[@]}"; do
    echo "Installing ${font} Nerd Font..."
    getnf -i "$font"
  done

  echo "$(check) Nerd fonts installed"
}

function prep_install_dir {
  [ ! -d "$XDG_CONFIG_HOME" ] && mkdir -p "$XDG_CONFIG_HOME"

  DVIM_CONFIG_HOME="$XDG_CONFIG_HOME"/dvim

  # Check if it exists as a symlink
  if [ -L "$DVIM_CONFIG_HOME" ]; then
    echo "$(check) $DVIM_CONFIG_HOME symlink exists"
    return
  fi

  # Check if it exists as a file (error case)
  if [ -e "$DVIM_CONFIG_HOME" ]; then
    echo "$(cross) ERROR: $DVIM_CONFIG_HOME exists but is not a dir or symlink."
    exit 1
  fi

  if ! ln -s "$ROOT_DIR" "$DVIM_CONFIG_HOME"; then
    echo "$(cross) ERROR: Failed to create symlink at $DVIM_CONFIG_HOME"
    exit 1
  fi

  echo "$(check) Symlink created at $DVIM_CONFIG_HOME"
}

function install_claude_acp {
  # Check if npm is installed
  if ! command -v npm &>/dev/null; then
    echo "$(warn) WARNING: npm not installed. Skipping claude-code-acp install."
    echo "    Install npm to enable claude-code-acp support."
    return
  fi

  # Check if claude-code-acp is already installed
  if npm list -g claude-code-acp &>/dev/null; then
    echo "$(check) claude-code-acp is already installed"
    return
  fi

  # Install claude-code-acp
  echo "Installing claude-code-acp..."
  if npm install -g claude-code-acp; then
    echo "$(check) claude-code-acp successfully installed"
  else
    echo "$(cross) ERROR: Failed to install claude-code-acp"
  fi
}

###############################################################################

function main() {
  XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"

  prep_local_bin
  prep_fonts_dir
  prep_install_dir
  install_fonts
  install_claude_acp

  if [ ! -f "$HOME"/.local/bin/dvim ]; then
    cat >>"$HOME"/.local/bin/dvim <<EOF
#!/usr/bin/env bash

XDG_CONFIG_HOME="\${XDG_CONFIG_HOME:-\$HOME/.config}"
export NVIM_APPNAME=\${NVIM_APPNAME:-"dvim"}
exec -a "\$NVIM_APPNAME" nvim -u "\$XDG_CONFIG_HOME"/dvim/init.lua "\$@"
EOF
    chmod +x "$HOME"/.local/bin/dvim
    echo "$(check) Created ${DVIM_CONFIG_HOME/"$HOME"/\~} executable"
  fi

  # Run headless plugin install to avoid first-run errors
  echo "Installing plugins (headless)..."
  if dvim --headless "+Lazy! sync" +qa 2>/dev/null; then
    echo "$(check) Plugins installed"
  else
    echo "$(warn) Plugin install had errors (this is usually fine, run dvim to complete)"
  fi

  echo "$(check) dvim successfully installed"
}

main "$@"
